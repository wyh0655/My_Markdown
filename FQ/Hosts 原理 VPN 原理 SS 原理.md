# Hosts 原理 VPN 原理 SS 原理

标签（空格分隔）： Hosts VPN ss 

---

## Hosts 原理

- 为了方便用户记忆，我们将IP变成一个个的域名来输入到浏览器进行访问。而这使得访问网站时要先将其域名解析成 IP 。DNS (Domain Name Server) 的作用就是进行 IP 解析，把域名对应到 IP。在 Great FireWall 的 5 种封锁方法中，有一种简单而效果很好的方法是 DNS 污染。GFW 会对 DNS 的解析过程进行干扰，这会使对某些被干扰的域名返回一个错误的 IP 地址给你的主机，使你无法正确连接到你要的服务器上读取正确的信息。


- Hosts 文件本来是用来提高解析效率。在进行 DNS 请求以前，系统会先检查自己的 Hosts 文件中是否有这个地址映射关系，如果有则调用这个 IP 地址映射，如果没有再向已知的 DNS 服务器提出域名解析。也就是说 Hosts 的请求级别比 DNS 高。当你的 Hosts 文件里面有对应的 IP 时，它就会直接访问那个 IP，而不用通过 DNS。所以，当我们直接将 Google、Twitter、Facebook 之类的 IP 放入 Hosts 文件后，就可以跳过 DNS 的解析这一步，直接就行 IP 访问，不受 GFW 的 DNS 污染干扰了。


- 补充一条，就是为什么 Hosts 的 IP 要时不时更改，为什么 FB、Twitter 会仍旧上不去。是因为 GFW 的第二个大招，IP 封锁。比如访问国外一个 IP 无法访问，Ping 不通，tracert 这个 IP 后发现，全部在边缘路由器 (GFW) 附近被拦截。换言之，GFW 直接拦截带有这个 IP 头的数据包。所以，如果你更改的 IP 被封锁了，就算你过了 DNS 这一关，也仍旧不能翻过 GFW。


---

## VPN原理 
 
- VPN代理，是在VPN（Virtual Private Network）虚拟专用网络的基础上衍生出来的提高网络访问速度和安全的技术。它利用VPN的特殊加密通讯协议在因特网位于不同地方的两个结点间临时建立一条穿过混乱公用网络的安全稳定的专用隧道。

- VPN代理是前端计算机和VPN服务器之间的点对点连接，在连接成功后建立一个虚拟专用隧道。前端将原本要发送给目标服务器的请求通过隧道发送给VPN代理服务器，然后VPN代理服务器再将请求转发给目标服务器。VPN代理服务器在将通讯请求发送给目标服务器的过程中，对请求数据包进行加密压缩处理。VPN代理服务器接收到目标服务器的响应后，也原样转发给前端计算机。

![8601a18b87d6277f10938f2128381f30e924fc22.gif](https://ooo.0o0.ooo/2016/02/22/56cbc5c77e792.gif)

- 使用VPN代理不光在网速上得到了一个提升而且VPN代理将根据地理位置转换服务器IP段，即实现本土IP变换成国外IP段。这样即在速度上得到了保障，而且在访问国外不能访问的网页上也达到了畅通无阻的效果。例如：YouTube，facebook，在我们国内网络用户上是不可访问的。而挂着VPN代理即可解决。


---

## 写给非专业人士看的 Shadowsocks 简介

这个文章来源于一个朋友在科学上网的过程中，搞不清楚 Shadowsocks 的配置问题，在这里我想按照我对 Shadowsocks 的理解简单梳理一下，以便一些非专业人士也能了解

### **long long ago…**

在很久很久以前，我们访问各种网站都是简单而直接的，用户的请求通过互联网发送到服务提供方，服务提供方直接将信息反馈给用户

![whats-shadowsocks-01.png](https://ooo.0o0.ooo/2016/02/22/56cbcde739cb7.png)

### **when evil comes**

然后有一天，GFW 就出现了，他像一个收过路费的强盗一样夹在了在用户和服务之间，每当用户需要获取信息，都经过了 GFW，GFW将它不喜欢的内容统统过滤掉，于是客户当触发 GFW 的过滤规则的时候，就会收到 Connection Reset 这样的响应内容，而无法接收到正常的内容

![whats-shadowsocks-02.png](https://ooo.0o0.ooo/2016/02/22/56cbcde754413.png)

### **ssh tunnel**

聪明的人们想到了利用境外服务器代理的方法来绕过 GFW 的过滤，其中包含了各种HTTP代理服务、Socks服务、VPN服务… 其中以 ssh tunnel 的方法比较有代表性

1) 首先用户和境外服务器基于 ssh 建立起一条加密的通道 2-3) 用户通过建立起的隧道进行代理，通过 ssh server 向真实的服务发起请求 4-5) 服务通过 ssh server，再通过创建好的隧道返回给用户


![whats-shadowsocks-03.png](https://ooo.0o0.ooo/2016/02/22/56cbcde75661e.png)

由于 ssh 本身就是基于 RSA 加密技术，所以 GFW 无法从数据传输的过程中的加密数据内容进行关键词分析，避免了被重置链接的问题，但由于创建隧道和数据传输的过程中，ssh 本身的特征是明显的，所以 GFW 一度通过分析连接的特征进行干扰，导致 ssh 存在被定向进行干扰的问题

### **shadowsocks**

于是 clowwindy 同学分享并开源了他的解决方案

简单理解的话，shadowsocks 是将原来 ssh 创建的 Socks5 协议拆开成 server 端和 client 端，所以下面这个原理图基本上和利用 ssh tunnel 大致类似

1、6) 客户端发出的请求基于 Socks5 协议跟 ss-local 端进行通讯，由于这个 ss-local 一般是本机或路由器或局域网的其他机器，不经过 GFW，所以解决了上面被 GFW 通过特征分析进行干扰的问题 2、5) ss-local 和 ss-server 两端通过多种可选的加密方法进行通讯，经过 GFW 的时候是常规的TCP包，没有明显的特征码而且 GFW 也无法对通讯数据进行解密 3、4) ss-server 将收到的加密数据进行解密，还原原来的请求，再发送到用户需要访问的服务，获取响应原路返回 

![whats-shadowsocks-04.png](https://ooo.0o0.ooo/2016/02/22/56cbcde75735f.png)



---

## 目前热门科学上网方式介绍及优缺点简评 

科学上网主要有两大类：“翻墙”和“穿墙”。“翻墙”主要方式是代理、VPN，需要国外代理服务器，“穿墙”则是读懂GFW的特性，使用特殊方式使得GFW的屏蔽失效。

“翻墙”受代理服务器连接速度的制约，一个日本代理对于东部沿海城市，一个香港代理对于南方城市来说一般速度较好，而最为常见的美国代理往往速度堪忧，毕竟在地球另一边。

而“穿墙”混淆了GFW使得它无法无法屏蔽你的连接，是直连站点的服务器了，通常速度较好，但毕竟能“穿”的站点有限，许多站点光“穿墙”是不行的，因此有许多科学上网工具采用了“穿”、“翻”结合的方式。

 

穿墙：
 

1、HOSTS
原理：GFW的封锁策略中，对启用了cdn的站点不可能进行简单的封IP策略，多采用劫持、污染DNS记录、HTTP阻断、HTTPS干扰等各种方式，个别IP被封锁也是有的。Google、facebook等这类站点，通过DNS查询获取的IP通常位于香港或者美国，而这些IP有不少要么被封、要么速度慢，有的干脆GFW没封锁你也连不上，而修改hosts，就是将这类站点的域名，指向国内服务器、或者国外没有被封、速度尚可的服务器。这样就可以直接避免了GFW的干扰完成“穿墙”。

优点：“穿墙”速度较好，对于google部分站点，是有国内服务器的，甚至可以获得更快的速度。

缺点：google、facebook这些站点通常服务器非常多，采用了CDN，本来通过DNS查询后会连到他们的CDN服务器上，再根据你的地理位置、服务器状态等情况为你跳出一个相对优质的服务器。然而hosts只能选择固定的服务器，你会发现有些网络条件下，诸如smart hosts之类的列表中的IP很多根本就ping不通，导致你无法连接某些服务器，而且不同ISP，不同地区，情况都不同。加上这些服务器老在变，你必须经常更新你的hosts，否则哪天可能网站就上不了了，非常的不便。导致一个hosts难以解决全国各地的需求。

2、流量混淆
原理：其实是加密的一种，只不过这种加密会导致流量所使用的协议都会变得难以分辨，使得GFW无法识别你是使用了HTTPS还是OpenVPN还是说其他的协议类型。局限性较大，需要服务器支持，通常与其他翻墙类科学上网方式相结合，达成防GFW阻断的功能，不单一使用，不再赘述。

3、加密协议
原理：使用加密的协议来进行数据传输，通常针对GFW的关键字审查。加密后的数据GFW无法进行关键字审查，从而避免GFW的连接重置阻断。网页服务通常使用HTTPS协议（SSL加密），而其他软件不少也有自己的自定义加密连接协议。常见的例子是使用 https://www.google.com/ 来进行搜索避免搜索某些敏感关键字时候遭遇连接重置，类似的还有维基百科。chrome浏览器可使用hsts功能强制开启站点的https。

优点：非常直接的穿墙方式，同样是直连，如果能连上的话，速度有保障。

缺点：局限性较大，一是服务器可能不支持HTTPS，二是GFW会特殊照顾一些名气较大的站点，这些站点你开了HTTPS照样会被阻断。

翻墙
1、普通HTTP/SOCKS代理
最常见的代理方式了，利用HTTP，socks等方式进行代理，应用非常广泛，远不止科学上网领域。然而这种连接方式未经加密，依然会遭遇连接重置，基本是完全暴露给GFW，不适合目前的网络环境，随时可能挂掉。

2、变式HTTP/SOCKS代理
这是目前主流的翻墙方式，使用自家协议防止GFW简单识别代理协议并阻断，并且可以使用AES等加密方式加密流量来进行代理，比较出名的有goagent和shadowsocks。

goagent比较特殊，利用Google App Engine（GAE）来做代理服务器，利用了GFW不可能封杀GAE但GAE却可以直连被墙站点的特性。GAE的特性也决定了其速度相当不错，而goagent封装的代理数据包在多数地区就算未加密也没有收到干扰可以无障碍通讯。部分地区可能需要加密数据。

优点：使用谷歌服务器代理，速度快，较稳定。通过代理上网的用户可以配置二级代理也可以翻墙。

缺点：部署略繁琐，受限于GAE，HTTP代理没有问题可是不能实现HTTPS代理，只能采用了伪HTTPS代理，导致必须导入其根证书。安卓下的客户端不是很好用。看网页尚可，其他应用用了自己协议的就有很多无法代理了。

而shadowsocks则是一款轻量级socks5代理，在安卓机子上很出名。使用Linux服务器做代理，必须有国外代理服务器，手机版提供了一个公共代理，速度尚可。

优点：使用完整Linux服务器代理而不是GAE这种功能受限的Web host，shadowsocks可以完整代理你所有类型的流量。跨平台，主流操作系统均有支持的客户端。

缺点：受限于代理服务器的连接速度，除非你使用离你所在地距离较近的国外代理服务器，否则速度上很难达到goagent的速度。

3、混合式代理
这类的代表就是fqrouter，穿墙加翻墙，用到了上面提到的所有方式。穿墙用了流量混淆和类似hosts的技术，翻墙则混用了goagent和shadowsocks，能走goagent的走goagent，HTTPS之类的不能走的走shadowsocks。fqroutwr不使用goagent的伪HTTPS代理。

fqrouter提供了不少公共goagent和shadowsocks代理，并智能判断是否走代理，能直连的直连。简单易用。你也可以添加自己的代理，goagent、shadowsocks、其他HTTP代理都可以添加

优点：混用多种方案，可解决大多数被墙网站，速度较快，稳定

缺点：方式较复杂，虽然效果好但耗电量会大些；只有安卓版；客户端不支持二级代理，可能需要借助第三方软件才能实现。

当然，通过对代理管理软件的配置，自己也能配置出混合代理方式。见这篇文章

4、VPN
这个算是终极方案了，在代理无效的情况下，利用VPN技术进行翻墙。

优点：如果连接没有问题，几乎可以解决任何被墙站点的访问问题。

缺点：许多VPN只在Windows/Linux下有客户端，对于android、ios的支持不是很好。

GFW对于VPN的封杀无时无刻不在进行，最典型的就是GFW早已可以准确识别OpenVPN，原理是利用协议在握手阶段的某些特征来检测，从而可以达成瞬间阻断OpenVPN连接，很有可能你连第一次连接都连不上就被检测到了。而且这还没完，你胆敢用OpenVPN的后果，就是服务器IP立马被照顾，所有不能被识别的加密流量均会被阻断。我就尝试在自己的VPS上部署了一次OpenVPN，然后连不上，接着第二天发现自己部署在VPS上的shadowsocks也连不上了。能连上的加密协议只有SSH、HTTPS（SSL）这类，无奈最终换IP，还好提供商的snapshot功能很好用，很快就搞好了。

所以现在使用VPN，不能使用原生的OpenVPN。必须使用变式的OpenVPN或者其他类的VPN软件。比如说给流量做混淆，再比如使用GFW目前无法识别的VPN，比如：SoftEther VPN（见这篇文章）

VPN很多都是收费的因为要购买服务器，而且很多都是美国VPN速度不怎么样。收费VPN也购买过一些小公司搞的便宜的VPN，网络质量多数不是太好，速度一般，国外有不少大一点的VPN提供商，质量好些但是普遍都比较贵。

而免费的VPN里，VPN GATE是个不错的选择，全球分布式VPN，速度很快。也有人用地下铁之类的，我没用过不知道怎么样，不做讨论了。

GFW对于VPN是坚决封杀的，目前引入的流量检测技术，识别流量类型，导致很多VPN都跪了。加之目前的“有罪推定”这一蛋疼的方式，导致一切加密手段都变成了浮云。无论你使用多复杂的加密手段都没用，GFW会认为所有他认不出来的加密浏览都是“犯罪嫌疑人”，并对这些流量进行监控。如果满足一定的条件，GFW将会判定“罪名成立”并处“暂时截断所有不能识别的加密浏览”等类似处罚，也就是“死缓”，如果屡教不改者判以“死刑立即执行”，予以永久封IP处罚。

总之能代理就先代理，代理不行再挂VPN，VPN要少用，万一被检测出来，后果很严重。。说不定你花钱买的VPN就这么跪了，钱就白瞎进去了。